"""
Chatbot Manager module for GraphBit-based conversational AI.
This module provides a comprehensive chatbot implementation using GraphBit's
workflow system, with vector database integration for context retrieval and
memory storage capabilities.
"""

import logging
import os
from typing import List, Optional

from dotenv import load_dotenv

import graphbit

load_dotenv()

os.makedirs("logs", exist_ok=True)
logging.basicConfig(filename="logs/chatbot.log", filemode="a", format="%(asctime)s - %(levelname)s - %(message)s", level=logging.INFO)

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY", "")
OPENAI_LLM_MODEL = "gpt-3.5-turbo"
OPENAI_EMBEDDING_MODEL = "text-embedding-3-small"
MAX_TOKENS = 200


class LLMManager:
    """
    LLMManager handles the configuration and interaction with the language model client.

    This class manages the OpenAI language model and embedding clients, providing methods
    for generating responses, embeddings, and streaming chat completions.
    """

    def __init__(self, api_key: Optional[str] = OPENAI_API_KEY):
        """
        Initialize the LLMManager with the OpenAI API key.

        Args:
            api_key (str): OpenAI API key for accessing the language model.
        """
        graphbit.init()

        # Ensure OpenAI API key is present
        if not api_key:
            api_key = os.getenv("OPENAI_API_KEY")
        if not api_key:
            raise ValueError("OPENAI_API_KEY environment variable is not set. Please set it in your environment.")

        # Configure LLM
        self.llm_config = graphbit.LlmConfig.openai(model=OPENAI_LLM_MODEL, api_key=api_key)
        self.llm_client = graphbit.LlmClient(self.llm_config)

        # Configure embeddings
        self.embedding_config = graphbit.EmbeddingConfig.openai(model=OPENAI_EMBEDDING_MODEL, api_key=api_key)
        self.embedding_client = graphbit.EmbeddingClient(self.embedding_config)

    def embed(self, text: str) -> List[float]:
        """Generate embeddings for the given text using the configured embedding model."""
        return self.embedding_client.embed(text)

    def embed_many(self, texts: List[str]) -> List[List[float]]:
        """Generate embeddings for multiple texts using the configured embedding model."""
        return self.embedding_client.embed_many(texts)

    async def chat_stream(self, prompt: str):
        """
        Stream chat response tokens from the LLM client.

        This method provides a streaming interface for chat completions, yielding
        response tokens as they are generated by the language model.

        Args:
            prompt (str): The input prompt to send to the language model.

        Yields:
            str: Individual response tokens from the streaming completion.
        """
        response = await self.llm_client.complete_stream(prompt, max_tokens=MAX_TOKENS)
        for chunk in response:
            yield chunk

